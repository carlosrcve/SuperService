{% extends "base.html" %}

{% load static %}

{% block title %}Solicitar Viaje{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<style>
/* Estilos generales de interacci贸n */
#solicitarViajeForm input,
#solicitarViajeForm select,
#solicitarViajeForm textarea {
    border-radius: 8px;
    transition: border-color 0.2s;
}
#solicitarViajeForm input:focus,
#solicitarViajeForm select:focus,
#solicitarViajeForm textarea:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* ----------------------------------------------------------------- */
/*  SOLUCIONES CRTICAS PARA EL RENDERIZADO DEL MAPA (CSS)       */
/* ----------------------------------------------------------------- */

/* 1. Contenedor padre: Altura fija obligatoria y refuerzo contra Flexbox. */
.card-body.p-0 {
    display: block !important; 
    min-height: 500px !important;
    height: 500px !important; /* ALTURA FIJA ES ESENCIAL */
    padding: 0 !important;
    position: relative !important;
    overflow: hidden;
    flex-shrink: 0; 
    flex-grow: 0; 
}

/* 2. Contenedor del mapa (hijo): 100% de la altura de su padre. */
#mapa-selector {
    height: 100% !important; 
    width: 100% !important;
    box-sizing: border-box !important;
    margin-bottom: 0;
    border-bottom-left-radius: 15px; 
    border-bottom-right-radius: 15px;
    position: relative !important;
}

/* Estilo para la barra de b煤squeda del geocodificador */
.leaflet-control-geocoder {
    margin-top: 10px;
    margin-left: 10px;
    max-width: 90%;
    z-index: 1000;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

    {% if not viaje or not viaje.id %}
    <div class="alert alert-warning mb-4">
        <h5 class="alert-heading fw-bold"> Verificaci贸n de Viaje Pendiente</h5>
        <p class="mb-1">Usuario Logueado: <strong>{{ request.user.username }}</strong></p>
        <p class="mb-1">Variable 'viaje' recibida: <strong>{{ viaje }}</strong></p>
        <p>ID del Viaje Encontrado: <strong>{{ viaje.id|default:"(No se encontr贸 un viaje activo/pendiente)" }}</strong></p>
        <small>Si el ID es "(No se encontr贸 un viaje activo)", la vista NO est谩 pasando un viaje pendiente al contexto, por lo tanto, el bot贸n no se mostrar谩. **Verifica los ESTADOS en tu views.py.**</small>
    </div>
    {% endif %}
        <div class="row g-4">
        
        <div class="col-lg-5">
            <div class="card shadow-lg border-0" style="border-radius: 15px;">
                <div class="card-header text-center py-3" style="background-color: var(--bs-primary); border-top-left-radius: 15px; border-top-right-radius: 15px;">
                    <i class="bi bi-geo-alt-fill text-white display-6 mb-1"></i>
                    <h4 class="text-white fw-bold mb-0">驴A d贸nde vamos, {{ user.get_full_name|default:user.username }}?</h4>
                </div>
                <div class="card-body p-4">
                    <form id="solicitarViajeForm" method="post">
                        {% csrf_token %}
                        
                        <input type="hidden" id="origen-lat-lng" name="origen_lat_lng" value="">
                        <input type="hidden" id="destino-lat-lng" name="destino_lat_lng" value="">
                        <input type="hidden" id="nombre-origen" name="nombre_origen" value="">
                        <input type="hidden" id="nombre-destino" name="nombre_destino" value="">

                        <div class="mb-4">
                            <label for="origen" class="form-label fw-bold"><i class="bi bi-circle-fill text-success small me-2"></i> Punto de Partida (Origen)</label>
                            <p class="form-control form-control-lg bg-light" id="origen-coords-display">
                                <span id="origen-coords">Seleccione en el mapa</span>
                            </p>
                        </div>

                        <div class="mb-4">
                            <label for="destino" class="form-label fw-bold"><i class="bi bi-pin-map-fill text-danger me-2"></i> Destino</label>
                            <p class="form-control form-control-lg bg-light" id="destino-coords-display">
                                <span id="destino-coords">Pendiente de Origen</span>
                            </p>
                        </div>
                        
                        <div class="django-form-fields">
                            {% for field in form %}
                                <div class="mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold mt-3 hover-lift" style="background-color: var(--bs-primary); border-radius: 10px;">
                            <i class="bi bi-car-front-fill me-2"></i> Solicitar Viaje Ahora
                        </button>
                    </form>

                    {# ----------------------------------------------------------- #}
                    {# Bloque Condicional para el Enlace de Detalle del Viaje #}
                    {# Este se muestra SOLO si la vista pas贸 un objeto 'viaje' activo. #}
                    {# ----------------------------------------------------------- #}
                    {% if viaje and viaje.id %}
                        <div class="mt-3 pt-3 border-top">
                            <h6 class="fw-bold text-success mb-2">Viaje Pendiente Encontrado</h6>
                            <a href="{% url 'transporte:viaje_detalle' viaje.id %}" class="btn btn-outline-success btn-sm w-100 fw-bold hover-lift" style="border-radius: 10px;">
                                <i class="bi bi-info-circle-fill me-1"></i> Ver Detalles del Viaje Actual
                            </a>
                        </div>
                    {% else %}
                        <div class="mt-3 pt-3 border-top">
                            <p class="text-muted small mb-0">Una vez solicitado, ver谩s aqu铆 el enlace al seguimiento.</p>
                        </div>
                    {% endif %}
                    {# ----------------------------------------------------------- #}

                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card shadow-lg border-0" style="border-radius: 15px;">
                <div class="card-header py-3 text-center" style="background-color: var(--bs-primary); border-top-left-radius: 15px; border-top-right-radius: 15px;">
                    <h5 class="text-white mb-0 fw-bold"><i class="bi bi-map-fill me-2"></i> Visualizaci贸n de Ruta y Selecci贸n</h5>
                </div>
                <div class="card-body p-0" style="border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;">
                    <div id="mapa-selector" class="w-100"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
// --- Variables Globales ---
const defaultLat = 40.7128; // Coordenada de ejemplo (Nueva York)
const defaultLng = -74.0060;
const defaultZoom = 13;

let map = null;
let geocoder = null; 
let currentStep = 'origen'; 

// Variables de Marcadores y Ruta
let originMarker = null;
let destinationMarker = null;
let routePolyline = null; 

// Variables DOM
const origenInput = document.getElementById('origen-lat-lng');
const destinoInput = document.getElementById('destino-lat-lng');
const origenDisplay = document.getElementById('origen-coords');
const destinoDisplay = document.getElementById('destino-coords');
const nombreOrigenInput = document.getElementById('nombre-origen');
const nombreDestinoInput = document.getElementById('nombre-destino');


// Iconos Personalizados
const originIcon = L.icon({ 
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', 
    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
});

const destinationIcon = L.icon({ 
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', 
    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
});


//  FUNCIN CRTICA: Inicializaci贸n de Leaflet
function initializeMap() {
    console.log("Intentando inicializar el mapa...");
    if (map) return; 

    try {
        map = L.map('mapa-selector', {
            attributionControl: false 
        }).setView([defaultLat, defaultLng], defaultZoom);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '漏 OpenStreetMap contributors' 
        }).addTo(map);

        setupMapInteractions();

        // **PASO CRTICO DE REDIBUJO:** Forzar redibujo y centrado.
        map.invalidateSize();
        setTimeout(() => {
            map.invalidateSize();
            map.setView([defaultLat, defaultLng], defaultZoom);
            console.log("Mapa forzado a redibujar y centrar.");
        }, 100); 

        L.control.attribution({position: 'bottomleft'}).addTo(map)
            .setPrefix('Leaflet | 漏 OpenStreetMap contributors');

    } catch (error) {
        console.error("Error FATAL al inicializar Leaflet:", error);
    }
}


// --- L贸gica de Interacciones ---

function setupMapInteractions() {
    if (!map) return;
    
    // Inicializaci贸n del Geocodificador
    geocoder = L.Control.Geocoder.nominatim();
    var control = L.Control.geocoder({
        geocoder: geocoder,
        collapsed: false,
        placeholder: 'Buscar direcci贸n de Origen/Destino...',
        errorMessage: 'Lo sentimos, no se encontr贸 la direcci贸n.',
    }).addTo(map);

    // Evento al marcar una geocodificaci贸n (b煤squeda)
    control.on('markgeocode', function(e) {
        updateLocation(e.geocode.center, e.geocode.name);
        map.fitBounds(e.geocode.bbox);
    });

    // Evento al hacer click en el mapa
    map.on('click', function(e) {
        // Geocodificaci贸n inversa (obtener direcci贸n del punto)
        geocoder.reverse(e.latlng, map.options.crs.getProjectedBounds(map.options.crs.projection), function(results) {
            updateLocation(e.latlng, results.length > 0 ? results[0].name : null);
        });
    });

    // Evento al hacer doble clic para reiniciar
    map.on('dblclick', function(e) {
        // Eliminar elementos del mapa
        if (originMarker) map.removeLayer(originMarker);
        if (destinationMarker) map.removeLayer(destinationMarker);
        if (routePolyline) map.removeLayer(routePolyline); // ELIMINAR RUTA
        
        originMarker = destinationMarker = routePolyline = null;

        // Limpiar campos y estado
        origenInput.value = destinoInput.value = nombreOrigenInput.value = nombreDestinoInput.value = '';
        origenDisplay.textContent = 'Seleccione en el mapa';
        destinoDisplay.textContent = 'Pendiente de Origen';
        currentStep = 'origen';
        
        map.setView([defaultLat, defaultLng], defaultZoom); 
        map.invalidateSize();
        console.log('Selecci贸n de viaje reiniciada.');
    });
}


/**
 * Dibuja o actualiza una polil铆nea simple entre Origen y Destino.
 */
function drawRoute() {
    if (routePolyline) {
        map.removeLayer(routePolyline);
    }
    
    if (originMarker && destinationMarker) {
        const originLatLng = originMarker.getLatLng();
        const destinationLatLng = destinationMarker.getLatLng();
        
        // Crea la polil铆nea con las coordenadas de los marcadores
        const latlngs = [
            [originLatLng.lat, originLatLng.lng],
            [destinationLatLng.lat, destinationLatLng.lng]
        ];

        routePolyline = L.polyline(latlngs, {
            color: 'blue',
            weight: 5,
            opacity: 0.7,
            dashArray: '10, 5' // L铆nea discontinua
        }).addTo(map);

        // Ajusta la vista para que incluya la l铆nea
        map.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
    }
}


function updateLocation(latlng, addressText) {
    if (!map) return;

    const finalAddressText = addressText || '';
    const coordsText = `Lat: ${latlng.lat.toFixed(6)}, Lon: ${latlng.lng.toFixed(6)}`;
    const displayContent = finalAddressText || coordsText; 
    const popupContent = finalAddressText ? `${finalAddressText} (${coordsText})` : coordsText;


    if (currentStep === 'origen') {
        if (originMarker) map.removeLayer(originMarker);
        
        originMarker = L.marker(latlng, { icon: originIcon, draggable: true }).addTo(map)
            .bindPopup(`**Origen:** ${popupContent}`).openPopup();
        originMarker.on('dragend', function(e) { updateMarkerLocation('origen', e.target.getLatLng()); });

        // Guardar valores
        origenInput.value = `${latlng.lat},${latlng.lng}`; 
        nombreOrigenInput.value = finalAddressText;
        origenDisplay.textContent = displayContent;

        // Cambiar estado
        currentStep = 'destino';
        destinoDisplay.textContent = 'Seleccione Destino (mapa o b煤squeda)';
        
    } else if (currentStep === 'destino') {
        if (destinationMarker) map.removeLayer(destinationMarker);
        
        destinationMarker = L.marker(latlng, { icon: destinationIcon, draggable: true }).addTo(map)
            .bindPopup(`**Destino:** ${popupContent}`).openPopup();
        destinationMarker.on('dragend', function(e) { updateMarkerLocation('destino', e.target.getLatLng()); });

        // Guardar valores
        destinoInput.value = `${latlng.lat},${latlng.lng}`;
        nombreDestinoInput.value = finalAddressText;
        destinoDisplay.textContent = displayContent;

        currentStep = 'finalizado';
        
        // DIBUJAR LA RUTA FINAL
        drawRoute(); 
        
    } else {
        // Si ya est谩 finalizado, el siguiente clic reinicia al origen
        currentStep = 'origen';
        updateLocation(latlng, addressText);
    }
}

function updateMarkerLocation(type, newLatLng) {
    const isOrigin = type === 'origen';
    const marker = isOrigin ? originMarker : destinationMarker;
    const input = isOrigin ? origenInput : destinoInput;
    const nameInput = isOrigin ? nombreOrigenInput : nombreDestinoInput;
    const display = isOrigin ? origenDisplay : destinoDisplay;
    const title = isOrigin ? 'Origen' : 'Destino';

    geocoder.reverse(newLatLng, map.options.crs.getProjectedBounds(map.options.crs.projection), function(results) {
        // Obtener el nombre de la direcci贸n o usar coordenadas si falla
        let newAddressText = results.length > 0 ? results[0].name : `(${newLatLng.lat.toFixed(6)}, ${newLatLng.lng.toFixed(6)})`;

        const coordsText = `Lat: ${newLatLng.lat.toFixed(6)}, Lon: ${newLatLng.lng.toFixed(6)}`;
        const displayContent = newAddressText !== coordsText ? newAddressText : coordsText; 
        const popupContent = `${newAddressText} (${coordsText})`;

        // Actualizar DOM e Inputs
        input.value = `${newLatLng.lat},${newLatLng.lng}`;
        nameInput.value = newAddressText;
        display.textContent = displayContent;

        marker.setPopupContent(`**${title}:** ${popupContent}`);
        marker.openPopup();
        console.log(`${title} actualizado por arrastre.`);
        
        // ACTUALIZAR LA RUTA DESPUS DE ARRASTRAR
        drawRoute(); 
    });
}

function applyBootstrapClassesToDjangoFields() {
    const fieldsContainer = document.querySelector('.django-form-fields');
    if (fieldsContainer) {
        fieldsContainer.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(element => {
            if (!element.classList.contains('form-control') && element.type !== 'checkbox' && element.type !== 'radio' && element.type !== 'file') {
                element.classList.add('form-control', 'form-control-lg');
            } else if (element.type === 'checkbox' || element.type === 'radio') {
                element.classList.add('form-check-input');
            }
        });
    }
}


// --- Event Handlers (Punto de Ejecuci贸n Corregido) ---

// 1. Aplica clases de Bootstrap tan pronto como el DOM est茅 listo.
document.addEventListener('DOMContentLoaded', applyBootstrapClassesToDjangoFields);

// 2. SOLUCIN FINAL DE INICIALIZACIN: Usa setTimeout para asegurar que el contenedor est谩 listo.
window.addEventListener('load', () => {
    //  VALOR AUMENTADO: Esperamos 500ms para asegurar que todo el CSS se haya aplicado.
    setTimeout(initializeMap, 500); 
});

</script>
{% endblock %}
