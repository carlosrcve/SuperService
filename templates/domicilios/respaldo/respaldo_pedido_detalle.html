{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Detalle del Pedido #{{ pedido.id }}{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2 class="mb-3">Detalle del Pedido #{{ pedido.id }}</h2>
    <p class="lead">Estado Actual: <strong>{{ pedido.get_estado_display }}</strong></p>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Informaci칩n de Entrega y Totales
        </div>
        <div class="card-body">
            <p><strong>Comercio:</strong> {{ pedido.comercio.nombre }}</p>
            <p><strong>Direcci칩n de Entrega:</strong> {{ pedido.direccion_entrega }}</p>
            <p><strong>Cliente:</strong> {{ pedido.cliente.username }}</p>
            
            {% if pedido.repartidor %}
                <p><strong>Repartidor Asignado:</strong> {{ pedido.repartidor.username }}</p>
            {% else %}
                <p class="text-warning"><strong>Repartidor Asignado:</strong> Buscando...</p>
            {% endif %}

            <hr>
            <h5>Resumen de Costos</h5>
            <p>Subtotal: ${{ pedido.subtotal }}</p>
            <p>Costo de Env칤o: ${{ pedido.costo_envio }}</p>
            <h4>Total Final: ${{ pedido.total_final }}</h4>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            Productos Solicitados
        </div>
        <div class="card-body">
            <ul>
                {% for item in items %}
                    <li>{{ item.cantidad }} x {{ item.producto.nombre }} (${{ item.subtotal_item }})</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <hr style="margin-top: 40px; margin-bottom: 40px;">

    <div class="chat-container" style="max-width: 600px; margin: 0 auto; border: 1px solid #ddd; padding: 20px; border-radius: 8px; background-color: #f9f9f9;">
        <h3 style="color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0;">游눫 Chat del Pedido #{{ pedido.id }}</h3>

        <div class="message-history" id="chat-window" style="height: 300px; overflow-y: scroll; padding: 10px; background-color: white; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px;">
            <div id="chat-log-django">
                {% for mensaje in mensajes %}
                    <div class="message-bubble" style="margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; 
                        {% if mensaje.emisor == user %}
                            background-color: #dcf8c6; float: right; clear: both;
                        {% else %}
                            background-color: #f1f0f0; float: left; clear: both;
                        {% endif %}
                        max-width: 85%;">
                        
                        <small style="font-size: 0.75em; color: #888;">
                            {% if mensaje.emisor == user %}T칰{% else %}{{ mensaje.emisor.username }}{% endif %}
                            - {{ mensaje.timestamp|date:"h:i A" }}
                        </small>
                        <p style="margin: 3px 0 0 0;">{{ mensaje.contenido }}</p>
                    </div>
                {% empty %}
                    <p style="text-align: center; color: #999; margin-top: 50px;">A칰n no hay mensajes en este pedido.</p>
                {% endfor %}
            </div>
            <div id="chat-log-websocket" style="clear: both;"></div> 
        </div>

        <div class="input-group">
            <input id="chat-message-input" type="text" class="form-control" placeholder="Escribe un mensaje..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <button id="chat-message-submit" type="button" style="display: block; width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer;">
                Enviar Mensaje
            </button>
        </div>
    </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. Obtener el ID del pedido del contexto de Django
    const pedidoId = "{{ pedido.id }}"; 
    
    // Elementos del DOM - 춰CORRECCI칍N APLICADA AQU칈!
    const chatWindow = document.querySelector('#chat-window'); 
    const chatLogWebsocket = document.querySelector('#chat-log-websocket');
    
    // 游뛀 CORRECCI칍N CR칈TICA: Cambiar el selector a #chat-message-text
    const messageInput = document.querySelector('#chat-message-input');
    
    const submitButton = document.querySelector('#chat-message-submit');

    // Funci칩n para desplazarse al final del chat
    function scrollToBottom() {
        if (chatWindow) {
            chatWindow.scrollTop = chatWindow.scrollHeight; 
        }
    }
    
    // 2. Conexi칩n WebSocket al Consumer de Pedido
    // 춰IMPORTANTE: Usar el puerto 8081 que indicaste!
    const chatSocket = new WebSocket(
        'ws://' + window.location.hostname + ':8081' + '/ws/pedido/' + pedidoId + '/'
    );

    chatSocket.onopen = function(e) {
        console.log("Conexi칩n WebSocket para Pedido abierta.");
        scrollToBottom(); 
    };

    chatSocket.onclose = function(e) {
        console.log("Conexi칩n WebSocket para Pedido cerrada inesperadamente.");
    };

    // 3. Manejo de Mensajes Recibidos (Inyecci칩n con estilo de burbuja)
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const username = data.username;
        const isMe = data.is_me; // Viene del Consumer

        // Crear el nuevo elemento de burbuja (Mismo estilo que el historial)
        const newBubble = document.createElement('div');
        newBubble.className = 'message-bubble';
        newBubble.style.marginBottom = '10px';
        newBubble.style.padding = '8px 12px';
        newBubble.style.borderRadius = '15px';
        newBubble.style.maxWidth = '85%';
        
        // Aplica el estilo de burbuja (float y color)
        if (isMe) {
            newBubble.style.backgroundColor = '#dcf8c6'; 
            newBubble.style.float = 'right';
            newBubble.style.clear = 'both';
        } 
        else {
            newBubble.style.backgroundColor = '#f1f0f0'; 
            newBubble.style.float = 'left';
            newBubble.style.clear = 'both';
        }

        // Crea y a침ade el contenido
        const smallTag = document.createElement('small');
        smallTag.style.fontSize = '0.75em';
        smallTag.style.color = '#888';
        smallTag.textContent = (isMe ? 'T칰' : username) + ' - ' + new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'}); 
        
        const pTag = document.createElement('p');
        pTag.style.margin = '3px 0 0 0';
        pTag.textContent = message;

        newBubble.appendChild(smallTag);
        newBubble.appendChild(pTag);

        chatLogWebsocket.appendChild(newBubble); 
        
        scrollToBottom();
    };

    // 4. Funci칩n de Env칤o del Mensaje
    function sendMessage() {
        // Aseguramos que el input existe antes de acceder a .value
        if (!messageInput) {
            console.error("Error: El campo de texto del chat no est치 definido.");
            return;
        }
        
        const message = messageInput.value.trim();
        if (message === "" || chatSocket.readyState !== 1) {
            if (chatSocket.readyState !== 1) console.error("WebSocket no est치 listo para enviar.");
            return; 
        }
        
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        
        messageInput.value = ''; // Limpiar el campo
    }

    // 5. Asignar Eventos (Clic en bot칩n y tecla Enter)
    if (submitButton) {
        submitButton.onclick = sendMessage;
    }

    if (messageInput) {
        messageInput.onkeyup = function(e) {
            if (e.key === 'Enter' && !e.shiftKey) { // Evita enviar en salto de l칤nea (Shift+Enter)
                sendMessage();
            }
        };
    }
    
    // Asegurar que el scroll baje al cargar la p치gina
    document.addEventListener('DOMContentLoaded', scrollToBottom);
</script>
{% endblock %}